<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hedera Mainnet Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root { --bg:#050810; --card:#161b22; --accent:#00d4ff; }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { 
    background:var(--bg); 
    color:white; 
    font-family:system-ui,-apple-system,sans-serif; 
    overflow-x:hidden;
    width:100vw;
  }
  html {
    overflow-x:hidden;
  }
  
  /* Subtle animated background orbs */
  .bg-orbs {
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    pointer-events:none;
    z-index:0;
    overflow:hidden;
  }
  .bg-orb {
    position:absolute;
    border-radius:50%;
    filter:blur(120px);
    opacity:0.15;
    animation:float 20s ease-in-out infinite;
  }
  .bg-orb:nth-child(1) {
    width:600px;
    height:600px;
    background:radial-gradient(circle,#8b5cf6,transparent);
    top:-200px;
    left:-200px;
    animation-delay:0s;
  }
  .bg-orb:nth-child(2) {
    width:500px;
    height:500px;
    background:radial-gradient(circle,#00d4ff,transparent);
    bottom:-150px;
    right:-150px;
    animation-delay:-7s;
  }
  .bg-orb:nth-child(3) {
    width:400px;
    height:400px;
    background:radial-gradient(circle,#ff00aa,transparent);
    top:50%;
    left:50%;
    animation-delay:-14s;
  }
  @keyframes float {
    0%, 100% { transform:translate(0, 0) scale(1); }
    25% { transform:translate(30px, -30px) scale(1.05); }
    50% { transform:translate(-20px, 20px) scale(0.95); }
    75% { transform:translate(20px, 10px) scale(1.02); }
  }
  
  .section {
    height:100vh;
    width:100%;
    position:relative;
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    overflow:visible;
    z-index:1;
  }
  #fixed-title {
    position:fixed;
    top:38%;
    left:0;
    right:0;
    text-align:center;
    transform:translateY(-50%);
    font-size:clamp(4rem,10vw,10rem);
    font-weight:900;
    z-index:100;
    pointer-events:none;
    background:linear-gradient(90deg,#00d4ff,#8b5cf6,#ff00aa);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
    white-space:nowrap;
  }
  h2 {
    font-size:clamp(2.5rem,6vw,5rem);
    font-weight:900;
    margin-bottom:3rem;
    background:linear-gradient(90deg,#00d4ff,#8b5cf6);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    white-space:nowrap;
  }
  .cards-wrapper {
    width:100%;
    padding:4rem 0;
    position:relative;
  }
  .carousel-scroll {
    width:100%;
    overflow:hidden;
    padding:2rem 0;
  }
  .carousel {
    display:flex;
    gap:2.5rem;
    padding:1.5rem 4rem;
    user-select:none;
    cursor:grab;
    width:max-content;
    will-change:transform;
  }
  .carousel:active {
    cursor:grabbing;
  }
  .carousel .card {
    flex-shrink:0;
  }
  @keyframes scroll {
    0%   { transform:translateX(0); }
    100% { transform:translateX(-50%); }
  }
  .card {
    flex:0 0 360px;
    height:210px;
    background:var(--card);
    border-radius:24px;
    padding:2.2rem;
    border:1px solid #30363d;
    backdrop-filter:blur(12px);
    box-shadow:0 8px 15px rgba(0,0,0,0.4);
    cursor:pointer;
    transition:transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    display:flex;
    flex-direction:column;
    justify-content:center;
    will-change:transform;
    position:relative;
    z-index:1;
  }
  .card:hover {
    transform:translateY(-8px) scale(1.02);
    box-shadow:0 15px 25px rgba(0,212,255,0.12);
    border-color:var(--accent);
    z-index:10;
  }
  .card-title { 
    font-size:0.9rem; 
    opacity:0.85; 
    margin-bottom:0.5rem;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .card-value { 
    font-size:2.5rem; 
    font-weight:800;
    background:linear-gradient(#00d4ff,#8b5cf6);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .gradient-orb {
    position:absolute;
    width:1400px; height:1400px;
    border-radius:50%;
    filter:blur(150px);
    opacity:0;
    pointer-events:none;
    z-index:0;
  }
  .search-box {
    padding:1.5rem 2rem;
    width:90%;
    max-width:620px;
    border:2px solid #30363d;
    border-radius:18px;
    background:#161b22;
    color:white;
    font-size:1.3rem;
    text-align:center;
    margin-bottom:2rem;
    transition:all 0.3s ease;
  }
  .search-box:focus {
    outline:none;
    border-color:var(--accent);
    box-shadow:0 0 30px rgba(0,212,255,0.3);
  }
  .search-btn {
    padding:1.2rem 3rem;
    background:linear-gradient(90deg,#00d4ff,#8b5cf6);
    border:none;
    border-radius:12px;
    color:white;
    font-size:1.1rem;
    font-weight:700;
    cursor:pointer;
    margin-bottom:2rem;
    transition:all 0.3s ease;
  }
  .search-btn:hover {
    transform:scale(1.05);
    box-shadow:0 10px 40px rgba(0,212,255,0.5);
  }
  .loading {
    display:none;
    font-size:1.2rem;
    opacity:0.7;
    margin-bottom:1rem;
  }
  .loading.active { display:block; }
  
  /* Rich List Styles */
  .richlist-container {
    width:90%;
    max-width:1200px;
    margin:0 auto;
  }
  .richlist-search {
    text-align:center;
    margin-bottom:3rem;
  }
  .rank-result {
    margin-top:1.5rem;
    padding:1.5rem;
    border-radius:16px;
    background:rgba(22,27,34,0.8);
    border:1px solid #30363d;
    display:none;
  }
  .rank-result.active {
    display:block;
  }
  .rank-number {
    font-size:3rem;
    font-weight:800;
    background:linear-gradient(135deg,#00d4ff,#8b5cf6);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    margin-bottom:0.5rem;
  }
  .rank-balance {
    font-size:1.3rem;
    color:#8b949e;
    margin-bottom:1rem;
  }
  .rank-percentile {
    font-size:1.1rem;
    width:120px;
    height:120px;
    border-radius:50%;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-weight:600;
  }
  .rank-percentile.top1 { background:linear-gradient(135deg,#ffd700,#ff8c00); color:#000; }
  .rank-percentile.top5 { background:linear-gradient(135deg,#c0c0c0,#a0a0a0); color:#000; }
  .rank-percentile.top10 { background:linear-gradient(135deg,#cd7f32,#8b4513); color:#fff; }
  .rank-percentile.top25 { background:rgba(139,92,246,0.3); color:#8b5cf6; }
  .rank-percentile.other { background:rgba(0,212,255,0.2); color:#00d4ff; }
  
  .richlist-subtitle {
    font-size:1.5rem;
    font-weight:700;
    margin-bottom:1.5rem;
    color:#8b949e;
    text-align:center;
  }
  .richlist-table-container {
    background:rgba(22,27,34,0.6);
    border-radius:24px;
    padding:2rem;
    border:1px solid #30363d;
    backdrop-filter:blur(12px);
    position:relative;
  }
  .back-btn {
    position:absolute;
    top:2rem;
    left:2rem;
    padding:0.8rem 1.5rem;
    background:rgba(139,92,246,0.2);
    border:1px solid #8b5cf6;
    border-radius:12px;
    color:#8b5cf6;
    font-size:0.9rem;
    font-weight:600;
    cursor:pointer;
    transition:all 0.3s ease;
    display:none;
    align-items:center;
    gap:0.5rem;
  }
  .back-btn.active {
    display:flex;
  }
  .back-btn:hover {
    background:rgba(139,92,246,0.4);
    transform:translateX(-4px);
  }
  .back-btn::before {
    content:'←';
    font-size:1.2rem;
  }
  .richlist-table {
    display:flex;
    flex-direction:column;
    gap:0.5rem;
    max-height:600px;
    overflow-y:auto;
    padding-right:0.5rem;
  }
  .richlist-table::-webkit-scrollbar {
    width:6px;
  }
  .richlist-table::-webkit-scrollbar-track {
    background:rgba(255,255,255,0.05);
    border-radius:3px;
  }
  .richlist-table::-webkit-scrollbar-thumb {
    background:rgba(139,92,246,0.5);
    border-radius:3px;
  }
  .richlist-row {
    display:flex;
    align-items:center;
    padding:1rem 1.5rem;
    background:rgba(22,27,34,0.8);
    border-radius:12px;
    border:1px solid #30363d;
    transition:all 0.2s ease;
    gap:1rem;
  }
  .richlist-row:hover {
    border-color:#8b5cf6;
    transform:translateX(4px);
  }
  .richlist-row.user-account {
    border:2px solid #00d4ff;
    background:rgba(0,212,255,0.15);
    box-shadow:0 0 20px rgba(0,212,255,0.3);
  }
  .richlist-rank {
    font-size:1.2rem;
    font-weight:800;
    min-width:70px;
    flex-shrink:0;
    color:#8b5cf6;
  }
  .richlist-rank.gold { color:#ffd700; }
  .richlist-rank.silver { color:#c0c0c0; }
  .richlist-rank.bronze { color:#cd7f32; }
  .richlist-address {
    flex:1;
    font-family:monospace;
    font-size:1rem;
    color:#8b949e;
    display:flex;
    flex-direction:column;
    gap:0.25rem;
    min-width:0;
    overflow:hidden;
  }
  .account-id {
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .account-name {
    font-size:0.85rem;
    color:#00d4ff;
    font-family:system-ui,-apple-system,sans-serif;
    font-weight:500;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .richlist-balance {
    font-size:1.1rem;
    font-weight:700;
    color:#00d4ff;
    text-align:right;
    min-width:150px;
    flex-shrink:0;
  }
</style>
</head>
<body>
  <!-- Subtle animated background orbs -->
  <div class="bg-orbs">
    <div class="bg-orb"></div>
    <div class="bg-orb"></div>
    <div class="bg-orb"></div>
  </div>
  
  <h1 id="fixed-title">HEDERA</h1>
  
  <section class="section" id="s1"></section>
  
  <section class="section" id="network">
    <div class="gradient-orb" id="networkOrb" style="background:radial-gradient(circle,rgba(0,212,255,0.3),rgba(139,92,246,0.2),transparent 70%);top:50%;left:50%;transform:translate(-50%,-50%);width:800px;height:800px;"></div>
    <h2 style="opacity:0;transform:scale(0.8);">NETWORK STATS</h2>
    <div class="loading" id="networkLoading">Loading...</div>
    <div class="cards-wrapper">
      <div class="carousel-scroll">
        <div class="carousel" id="networkCarousel">
          <div class="card"><div class="card-title">HBAR Price</div><div class="card-value" id="hbarPrice">---</div></div>
          <div class="card"><div class="card-title">Market Cap</div><div class="card-value" id="marketCap">---</div></div>
          <div class="card"><div class="card-title">Network TPS</div><div class="card-value" id="tps">---</div><div style="font-size:0.75rem;opacity:0.6;margin-top:0.5rem;">Live (30s window)</div></div>
          <div class="card"><div class="card-title">Consensus Time</div><div class="card-value" id="consensusTime">---</div></div>
          <div class="card"><div class="card-title">24h Network Fees</div><div class="card-value" id="networkFees">---</div></div>
          <div class="card"><div class="card-title">HBAR Released</div><div class="card-value" id="hbarReleased">---</div></div>
          <div class="card"><div class="card-title">Active Accounts</div><div class="card-value" id="activeAccounts">---</div></div>
          <div class="card"><div class="card-title">Total Accounts</div><div class="card-value" id="totalAccounts">---</div></div>
          <div class="card"><div class="card-title">24h New Accounts</div><div class="card-value" id="newAccounts">---</div></div>
          <div class="card"><div class="card-title">24h Transactions</div><div class="card-value" id="transactions">---</div></div>
        </div>
      </div>
    </div>
  </section>
  
  <section class="section" id="user">
    <div class="gradient-orb" style="top:-300px;left:-300px;background:radial-gradient(circle,rgba(139,92,246,0.18),transparent);"></div>
    <h2>USER DATA</h2>
    <input type="text" id="accountInput" class="search-box" placeholder="Enter account ID · 0.0.123456" onkeypress="if(event.key === 'Enter') queryAccount()">
    <button class="search-btn" onclick="queryAccount()">Query Account</button>
    <div class="loading" id="accountLoading">Loading...</div>
    <div class="cards-wrapper">
      <div class="carousel-scroll">
        <div class="carousel" id="userCarousel">
          <div class="card"><div class="card-title">Balance</div><div class="card-value" id="balance">---</div></div>
          <div class="card"><div class="card-title">Account ID</div><div class="card-value" id="accountId">---</div></div>
          <div class="card"><div class="card-title">EVM Address</div><div class="card-value" id="evmAddr" style="font-size:1.2rem;">---</div></div>
          <div class="card"><div class="card-title">Created</div><div class="card-value" id="created" style="font-size:1.8rem;">---</div></div>
        </div>
      </div>
    </div>
  </section>
  
  <section class="section" id="richlist" style="min-height:100vh;height:auto;padding:4rem 0;">
    <div class="gradient-orb" style="bottom:-300px;right:-300px;background:radial-gradient(circle,rgba(255,0,170,0.2),transparent);"></div>
    <h2>HBAR RICH LIST</h2>
    
    <div class="richlist-container">
      <!-- Search Section -->
      <div class="richlist-search">
        <input type="text" id="richlistInput" class="search-box" placeholder="Check your rank · 0.0.123456">
        <button class="search-btn" id="checkRankBtn">Check Rank</button>
        <div class="loading" id="rankLoading">Loading...</div>
        <div id="rankResult" class="rank-result"></div>
      </div>
      
      <!-- Top 50 List -->
      <div class="richlist-table-container">
        <button class="back-btn" id="backToTop50">Back to Top 50</button>
        <h3 class="richlist-subtitle">Top 50 HBAR Holders</h3>
        <div class="loading" id="richlistLoading">Loading...</div>
        <div class="richlist-table" id="richlistTable"></div>
      </div>
    </div>
  </section>
  
  <section class="section" id="final" style="background:transparent;">
    <h2>THE FUTURE IS HEDERA</h2>
    <p style="font-size:1.5rem;opacity:0.7;margin-top:2rem;">Powered by Hgraph API</p>
  </section>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>
<script>
const HGRAPH_API = 'https://mainnet.hedera.api.hgraph.io/v1/graphql';
const HGRAPH_KEY = 'pk_prod_138b03d98573dd8992cc9af61c748f56e329b09a';

gsap.to("#fixed-title", {opacity:0, filter:"blur(30px)", scale:0.88, ease:"none",
  scrollTrigger: {trigger:"#s1", start:"top top", end:"bottom top", scrub:0.6}
});
gsap.to("#network h2", {opacity:1, scale:1, duration:2, ease:"power4.out",
  scrollTrigger: {trigger:"#network", start:"top 70%"}
});
gsap.to("#network .gradient-orb", {opacity:1, scale:1.4, duration:3,
  scrollTrigger: {trigger:"#network", start:"top 60%"}
});

// Auto-load network data when section comes into view
ScrollTrigger.create({
  trigger: "#network",
  start: "top 80%",
  once: true,
  onEnter: () => {
    // Ensure carousels are initialized before querying
    if (!carouselsInitialized) {
      initCarousels();
    }
    queryNetwork();
    
    // Start live TPS updates
    startLiveTPSUpdates();
  }
});

// Initialize carousels when DOM is fully ready
let carouselsInitialized = false;

function initCarousels() {
  if (carouselsInitialized) {
    return;
  }
  carouselsInitialized = true;
  
  document.querySelectorAll('.carousel').forEach(carousel => {
    const wrapper = carousel.closest('.carousel-scroll');
    if (!wrapper) return;
    
    const cards = Array.from(carousel.children);
    if (cards.length === 0) return;
    
    const gap = 40;
    
    // Clone cards for seamless loop
    cards.forEach(card => {
      const clone = card.cloneNode(true);
      clone.querySelectorAll('[id]').forEach(el => el.removeAttribute('id'));
      carousel.appendChild(clone);
    });
    
    // Calculate set width
    let setWidth = 0;
    for (let i = 0; i < cards.length; i++) {
      setWidth += carousel.children[i].offsetWidth + gap;
    }
    
    // State
    let position = 0;
    let isInteracting = false;
    let isHovering = false;
    let isHoverReady = false;
    let timeout = null;
    let hoverTimeout = null;
    let dragging = false;
    let startX = 0;
    let dragStartPos = 0;
    
    // Apply transform
    function setPosition(x) {
      carousel.style.transform = `translateX(${x}px)`;
    }
    
    // Wrap position for infinite loop
    function wrapPosition() {
      if (setWidth <= 0) return;
      while (position <= -setWidth) {
        position += setWidth;
      }
      while (position > 0) {
        position -= setWidth;
      }
    }
    
    // Sync data from original cards to clones
    function syncClonedCards() {
      const allCards = carousel.querySelectorAll('.card');
      const numOriginal = cards.length;
      
      for (let i = 0; i < numOriginal; i++) {
        const originalValue = allCards[i].querySelector('.card-value');
        const cloneValue = allCards[i + numOriginal]?.querySelector('.card-value');
        if (originalValue && cloneValue && originalValue.textContent !== cloneValue.textContent) {
          cloneValue.textContent = originalValue.textContent;
        }
      }
    }
    
    // Animation loop
    function animate() {
      if (!isInteracting && !isHovering) {
        position -= 0.5;
        wrapPosition();
        setPosition(position);
      }
      // Sync clones every frame
      syncClonedCards();
      requestAnimationFrame(animate);
    }
    
    // Start animation
    requestAnimationFrame(animate);
    
    // Hover delay
    wrapper.addEventListener('mouseenter', () => {
      isHovering = true;
      hoverTimeout = setTimeout(() => {
        isHoverReady = true;
        wrapper.style.cursor = 'grab';
      }, 1000);
    });
    
    wrapper.addEventListener('mouseleave', () => {
      isHovering = false;
      isHoverReady = false;
      clearTimeout(hoverTimeout);
      wrapper.style.cursor = 'default';
      if (!dragging) {
        clearTimeout(timeout);
        timeout = setTimeout(() => { isInteracting = false; }, 1000);
      }
    });
    
    // Mouse wheel & trackpad
    wrapper.addEventListener('wheel', e => {
      if (!isHoverReady) return;
      
      e.preventDefault();
      isInteracting = true;
      clearTimeout(timeout);
      
      const delta = Math.abs(e.deltaX) > Math.abs(e.deltaY) ? e.deltaX : e.deltaY;
      position -= delta;
      wrapPosition();
      setPosition(position);
      
      timeout = setTimeout(() => { isInteracting = false; }, 1000);
    }, { passive: false });
    
    // Mouse drag
    wrapper.addEventListener('mousedown', e => {
      if (!isHoverReady) return;
      
      dragging = true;
      isInteracting = true;
      startX = e.clientX;
      dragStartPos = position;
      clearTimeout(timeout);
      wrapper.style.cursor = 'grabbing';
      e.preventDefault();
    });
    
    document.addEventListener('mousemove', e => {
      if (!dragging) return;
      position = dragStartPos + (e.clientX - startX);
      wrapPosition();
      setPosition(position);
    });
    
    document.addEventListener('mouseup', () => {
      if (dragging) {
        dragging = false;
        if (isHoverReady) {
          wrapper.style.cursor = 'grab';
        }
        timeout = setTimeout(() => { isInteracting = false; }, 1000);
      }
    });
    
    // Touch
    wrapper.addEventListener('touchstart', e => {
      dragging = true;
      isInteracting = true;
      isHoverReady = true;
      startX = e.touches[0].clientX;
      dragStartPos = position;
      clearTimeout(timeout);
    }, { passive: true });
    
    document.addEventListener('touchmove', e => {
      if (!dragging) return;
      position = dragStartPos + (e.touches[0].clientX - startX);
      wrapPosition();
      setPosition(position);
    }, { passive: true });
    
    document.addEventListener('touchend', () => {
      if (dragging) {
        dragging = false;
        timeout = setTimeout(() => { isInteracting = false; }, 1000);
      }
    });
  });
}

// Run carousel init immediately when DOM is ready, not on window load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initCarousels);
} else {
  initCarousels();
}

// Also run on window load as backup
window.addEventListener('load', initCarousels);

async function queryAccount() {
  const accountInput = document.getElementById('accountInput').value;
  const accountNum = parseInt(accountInput.replace('0.0.', ''));
  
  if (!accountNum) {
    alert('Please enter a valid account ID (e.g., 0.0.123456)');
    return;
  }
  
  document.getElementById('accountLoading').classList.add('active');
  
  try {
    const response = await fetch(HGRAPH_API, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': HGRAPH_KEY
      },
      body: JSON.stringify({
        query: `
          query GetAccount($accountNum: bigint!) {
            entity(where: {num: {_eq: $accountNum}, type: {_eq: "ACCOUNT"}}, limit: 1) {
              num
              balance
              evm_address
              created_timestamp
            }
          }
        `,
        variables: { accountNum }
      })
    });
    
    const result = await response.json();
    
    if (result.data?.entity?.[0]) {
      const account = result.data.entity[0];
      const balance = (account.balance / 100000000).toFixed(2);
      const created = new Date(account.created_timestamp / 1000000).toLocaleDateString();
      const evmAddr = account.evm_address ? `0x${Buffer.from(account.evm_address).toString('hex').slice(0, 8)}...` : 'N/A';
      
      document.getElementById('balance').textContent = `${balance} HBAR`;
      document.getElementById('accountId').textContent = `0.0.${account.num}`;
      document.getElementById('evmAddr').textContent = evmAddr;
      document.getElementById('created').textContent = created;
    } else {
      alert('Account not found');
    }
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    document.getElementById('accountLoading').classList.remove('active');
  }
}

async function queryNetwork() {
  document.getElementById('networkLoading').classList.add('active');
  
  try {
    const response = await fetch(HGRAPH_API, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': HGRAPH_KEY
      },
      body: JSON.stringify({
        query: `
          query GetNetworkStats {
            price: ecosystem_metric(
              where: {name: {_eq: "avg_usd_conversion"}, period: {_eq: "minute"}}
              order_by: [{end_date: desc_nulls_last}]
              limit: 1
            ) {
              total
            }
            marketCap: ecosystem_metric(
              where: {name: {_eq: "hbar_market_cap"}, period: {_eq: "day"}}
              order_by: [{end_date: desc_nulls_last}]
              limit: 1
            ) {
              total
            }
            consensusTime: ecosystem_metric(
              where: {name: {_eq: "avg_time_to_consensus"}, period: {_eq: "hour"}}
              order_by: [{end_date: desc_nulls_last}]
              limit: 1
            ) {
              total
            }
            networkFees: ecosystem_metric(
              where: {name: {_eq: "network_fee"}, period: {_eq: "day"}}
              order_by: [{end_date: desc_nulls_last}]
              limit: 1
            ) {
              total
            }
            hbarReleased: ecosystem_metric(
              where: {name: {_eq: "hbar_total_released"}, period: {_eq: "day"}}
              order_by: [{end_date: desc_nulls_last}]
              limit: 1
            ) {
              total
            }
            activeAccounts: ecosystem_metric(
              where: {name: {_eq: "active_accounts"}, period: {_eq: "day"}}
              order_by: [{end_date: desc_nulls_last}]
              limit: 1
            ) {
              total
            }
            totalAccounts: ecosystem_metric(
              where: {name: {_eq: "total_accounts"}, period: {_eq: "day"}}
              order_by: [{end_date: desc_nulls_last}]
              limit: 1
            ) {
              total
            }
            newAccounts: ecosystem_metric(
              where: {name: {_eq: "new_accounts"}, period: {_eq: "day"}}
              order_by: [{end_date: desc_nulls_last}]
              limit: 1
            ) {
              total
            }
            transactions: ecosystem_metric(
              where: {name: {_eq: "new_transactions"}, period: {_eq: "day"}}
              order_by: [{end_date: desc_nulls_last}]
              limit: 1
            ) {
              total
            }
          }
        `
      })
    });
    
    const result = await response.json();
    
    if (result.data) {
      // HBAR Price (÷100000 for USD)
      const price = result.data.price?.[0] ? `$${(result.data.price[0].total / 100000).toFixed(5)}` : 'N/A';
      
      // Market Cap (÷100 for USD)
      const marketCap = result.data.marketCap?.[0] 
        ? `$${(result.data.marketCap[0].total / 100 / 1000000000).toFixed(2)}B` 
        : 'N/A';
      
      // Consensus Time (÷1000000000 for seconds)
      const consensusTime = result.data.consensusTime?.[0] 
        ? `${(result.data.consensusTime[0].total / 1000000000).toFixed(2)}s` 
        : 'N/A';
      
      // Network Fees (÷100000000 for HBAR)
      const networkFees = result.data.networkFees?.[0] 
        ? `${(result.data.networkFees[0].total / 100000000).toLocaleString(undefined, {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
          })} ℏ`
        : 'N/A';
      
      // HBAR Released (÷100000000 for HBAR, then show in billions)
      const hbarReleased = result.data.hbarReleased?.[0] 
        ? `${(result.data.hbarReleased[0].total / 100000000 / 1000000000).toFixed(2)}B ℏ` 
        : 'N/A';
      
      // Active Accounts
      const active = result.data.activeAccounts?.[0]?.total?.toLocaleString() || 'N/A';
      
      // Total Accounts
      const total = result.data.totalAccounts?.[0]?.total?.toLocaleString() || 'N/A';
      
      // New Accounts (24h)
      const newAccounts = result.data.newAccounts?.[0]?.total?.toLocaleString() || 'N/A';
      
      // Transactions (24h)
      const txs = result.data.transactions?.[0]?.total?.toLocaleString() || 'N/A';
      
      document.getElementById('hbarPrice').textContent = price;
      document.getElementById('marketCap').textContent = marketCap;
      document.getElementById('consensusTime').textContent = consensusTime;
      document.getElementById('networkFees').textContent = networkFees;
      document.getElementById('hbarReleased').textContent = hbarReleased;
      document.getElementById('activeAccounts').textContent = active;
      document.getElementById('totalAccounts').textContent = total;
      document.getElementById('newAccounts').textContent = newAccounts;
      document.getElementById('transactions').textContent = txs;
    }
  } catch (error) {
    console.error('Error loading network stats:', error);
  } finally {
    document.getElementById('networkLoading').classList.remove('active');
  }
}

// Live TPS calculation function
async function updateLiveTPS() {
  try {
    const response = await fetch(HGRAPH_API, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': HGRAPH_KEY
      },
      body: JSON.stringify({
        query: `
          query GetLiveTPS {
            transaction(
              order_by: [{consensus_timestamp: desc}]
              limit: 200
            ) {
              consensus_timestamp
            }
          }
        `
      })
    });
    
    const result = await response.json();
    
    if (result.data?.transaction && result.data.transaction.length > 1) {
      const transactions = result.data.transaction;
      
      // Get timestamps in seconds
      const newestTime = transactions[0].consensus_timestamp / 1000000000;
      const oldestTime = transactions[transactions.length - 1].consensus_timestamp / 1000000000;
      
      // Calculate time span
      const timeSpan = newestTime - oldestTime;
      
      // Calculate TPS (only use transactions within last 30 seconds)
      if (timeSpan > 0) {
        // Filter to only transactions in last 30 seconds
        const thirtySecondsAgo = newestTime - 30;
        const recentTransactions = transactions.filter(tx => 
          (tx.consensus_timestamp / 1000000000) >= thirtySecondsAgo
        );
        
        const tps = (recentTransactions.length / Math.min(timeSpan, 30)).toFixed(2);
        document.getElementById('tps').textContent = tps;
      }
    }
  } catch (error) {
    console.error('Error updating live TPS:', error);
  }
}

// Start live TPS updates
let tpsInterval;
function startLiveTPSUpdates() {
  // Initial update
  updateLiveTPS();
  
  // Update every 10 seconds
  tpsInterval = setInterval(updateLiveTPS, 10000);
}

// Stop live updates when user leaves the page
window.addEventListener('beforeunload', () => {
  if (tpsInterval) {
    clearInterval(tpsInterval);
  }
});

// Rich List Functions
async function loadRichList() {
  document.getElementById('richlistLoading').classList.add('active');
  
  try {
    const response = await fetch(HGRAPH_API, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': HGRAPH_KEY
      },
      body: JSON.stringify({
        query: `
          query GetRichList {
            entity(
              where: {type: {_eq: "ACCOUNT"}, balance: {_gt: "0"}}
              order_by: [{balance: desc_nulls_last}]
              limit: 50
            ) {
              num
              balance
              memo
              evm_address
            }
          }
        `
      })
    });
    
    const result = await response.json();
    
    if (result.data?.entity) {
      const table = document.getElementById('richlistTable');
      table.innerHTML = '';
      
      // Update subtitle and hide back button
      document.querySelector('.richlist-subtitle').textContent = 'Top 50 HBAR Holders';
      document.getElementById('backToTop50').classList.remove('active');
      
      result.data.entity.forEach((account, index) => {
        const rank = index + 1;
        const balance = (account.balance / 100000000).toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
        
        let rankClass = '';
        if (rank === 1) rankClass = 'gold';
        else if (rank === 2) rankClass = 'silver';
        else if (rank === 3) rankClass = 'bronze';
        
        const accountName = account.memo ? `<div class="account-name">${account.memo}</div>` : '';
        
        const row = document.createElement('div');
        row.className = 'richlist-row';
        row.innerHTML = `
          <div class="richlist-rank ${rankClass}">#${rank}</div>
          <div class="richlist-address">
            <div class="account-id">0.0.${account.num}</div>
            ${accountName}
          </div>
          <div class="richlist-balance">${balance} ℏ</div>
        `;
        table.appendChild(row);
      });
    }
  } catch (error) {
    alert('Error loading rich list: ' + error.message);
  } finally {
    document.getElementById('richlistLoading').classList.remove('active');
  }
}

async function checkRank() {
  const accountInput = document.getElementById('richlistInput').value;
  const accountNum = parseInt(accountInput.replace('0.0.', ''));
  
  if (!accountNum) {
    alert('Please enter a valid account ID (e.g., 0.0.123456)');
    return;
  }
  
  document.getElementById('rankLoading').classList.add('active');
  document.getElementById('rankResult').classList.remove('active');
  
  try {
    // First, get the account's balance
    const accountResponse = await fetch(HGRAPH_API, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': HGRAPH_KEY
      },
      body: JSON.stringify({
        query: `
          query GetAccount($accountNum: bigint!) {
            entity(where: {num: {_eq: $accountNum}, type: {_eq: "ACCOUNT"}}, limit: 1) {
              num
              balance
            }
          }
        `,
        variables: { accountNum }
      })
    });
    
    const accountResult = await accountResponse.json();
    
    if (!accountResult.data?.entity?.[0]) {
      alert('Account not found');
      return;
    }
    
    const account = accountResult.data.entity[0];
    const balance = account.balance;
    const balanceHbar = (balance / 100000000).toLocaleString(undefined, {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
    
    // Then, count how many accounts have more HBAR
    const rankResponse = await fetch(HGRAPH_API, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': HGRAPH_KEY
      },
      body: JSON.stringify({
        query: `
          query GetRank($balance: bigint!) {
            entity_aggregate(
              where: {type: {_eq: "ACCOUNT"}, balance: {_gt: $balance}}
            ) {
              aggregate {
                count
              }
            }
            total: entity_aggregate(
              where: {type: {_eq: "ACCOUNT"}, balance: {_gt: "0"}}
            ) {
              aggregate {
                count
              }
            }
          }
        `,
        variables: { balance: balance.toString() }
      })
    });
    
    const rankResult = await rankResponse.json();
    const rank = rankResult.data.entity_aggregate.aggregate.count + 1;
    const totalAccounts = rankResult.data.total.aggregate.count;
    const percentile = ((rank / totalAccounts) * 100).toFixed(2);
    
    // Determine badge class
    let badgeClass = 'other';
    let badgeText = `Top ${percentile}%`;
    
    if (percentile <= 1) {
      badgeClass = 'top1';
      badgeText = 'Top 1%';
    } else if (percentile <= 5) {
      badgeClass = 'top5';
      badgeText = 'Top 5%';
    } else if (percentile <= 10) {
      badgeClass = 'top10';
      badgeText = 'Top 10%';
    } else if (percentile <= 25) {
      badgeClass = 'top25';
      badgeText = 'Top 25%';
    }
    
    // Display results
    const resultDiv = document.getElementById('rankResult');
    resultDiv.innerHTML = `
      <div class="rank-number">Rank #${rank.toLocaleString()}</div>
      <div class="rank-balance">${balanceHbar} ℏ</div>
      <div class="rank-percentile ${badgeClass}">${badgeText}</div>
      <p style="margin-top:1rem;opacity:0.7;">Out of ${totalAccounts.toLocaleString()} active accounts</p>
    `;
    resultDiv.classList.add('active');
    
    // Now load surrounding accounts (24 above, user, 25 below)
    await loadSurroundingAccounts(rank, accountNum);
    
  } catch (error) {
    alert('Error checking rank: ' + error.message);
  } finally {
    document.getElementById('rankLoading').classList.remove('active');
  }
}

async function loadSurroundingAccounts(userRank, userAccountNum) {
  document.getElementById('richlistLoading').classList.add('active');
  
  try {
    // Calculate offset (24 accounts above the user)
    const offset = Math.max(0, userRank - 25); // Start 24 above, or from rank 1 if user is in top 24
    
    const response = await fetch(HGRAPH_API, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': HGRAPH_KEY
      },
      body: JSON.stringify({
        query: `
          query GetSurroundingAccounts {
            entity(
              where: {type: {_eq: "ACCOUNT"}, balance: {_gt: "0"}}
              order_by: [{balance: desc_nulls_last}]
              limit: 50
              offset: ${offset}
            ) {
              num
              balance
              memo
              evm_address
            }
          }
        `
      })
    });
    
    const result = await response.json();
    
    if (result.data?.entity) {
      const table = document.getElementById('richlistTable');
      table.innerHTML = '';
      
      // Update subtitle to show context and show back button
      document.querySelector('.richlist-subtitle').textContent = 
        `Accounts Around Rank #${userRank.toLocaleString()}`;
      document.getElementById('backToTop50').classList.add('active');
      
      result.data.entity.forEach((account, index) => {
        const rank = offset + index + 1;
        const balance = (account.balance / 100000000).toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
        
        let rankClass = '';
        if (rank === 1) rankClass = 'gold';
        else if (rank === 2) rankClass = 'silver';
        else if (rank === 3) rankClass = 'bronze';
        
        const isUserAccount = account.num === userAccountNum;
        const userLabel = isUserAccount ? ' (You)' : '';
        const accountName = account.memo ? `<div class="account-name">${account.memo}</div>` : '';
        
        const row = document.createElement('div');
        row.className = `richlist-row${isUserAccount ? ' user-account' : ''}`;
        row.innerHTML = `
          <div class="richlist-rank ${rankClass}">#${rank}</div>
          <div class="richlist-address">
            <div class="account-id">0.0.${account.num}${userLabel}</div>
            ${accountName}
          </div>
          <div class="richlist-balance">${balance} ℏ</div>
        `;
        table.appendChild(row);
      });
      
      // Scroll the user's account into view
      setTimeout(() => {
        const userRow = table.querySelector('.user-account');
        if (userRow) {
          userRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }, 100);
    }
  } catch (error) {
    alert('Error loading surrounding accounts: ' + error.message);
  } finally {
    document.getElementById('richlistLoading').classList.remove('active');
  }
}

// Auto-load rich list when section comes into view
ScrollTrigger.create({
  trigger: "#richlist",
  start: "top 80%",
  once: true,
  onEnter: () => {
    loadRichList();
  }
});

// Add event listener for the Check Rank button
document.getElementById('checkRankBtn').addEventListener('click', checkRank);

// Allow Enter key to check rank
document.getElementById('richlistInput').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    checkRank();
  }
});

// Add event listener for back to top 50 button
document.getElementById('backToTop50').addEventListener('click', loadRichList);
</script>
</body>
</html>
